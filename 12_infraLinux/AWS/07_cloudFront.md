# CloudFront

전 세계에 파일을 빠른 속도로 배포하는 CDN 서비스

## 쓰는 이유

- 전세계를 대상으로 하는 서비스를 준비할 때 세계 곳곳에 서버를 구축하는 것은 현실적으로 여러움
- AWS를 사용하더라도 모든 리전에 EC2 인스턴스나 S3 버킷을 생성하는 것은 비효율적이며 돈도 많이 듬
- 51개의 에지 로케이션이 전 세계 주요 지역에 위치하고 있음. 따라서 각 사용자들은 가장 가까운 에지 로케이션에서 파일을 받으므로 다운로드 속도가 빨라짐
- EC2와 S3는 동작하는 장소가 리전에 한정적임. 따라서 멀리 떨어진 지역에서 접속할 경우 전송 속도가 상당히 느리다. 이때 CloudFront를 사용하여 EC2, ELB, S3 버킷의 내용을 에지 로케이션에 캐시하면 더 빠른 성능을 낼 수 있음

## 동작

- 사용자가 맨 처음 에지 로케이션에 접속했을 때 원하는 파일이 있으면 에지 로케이션에서 바로 파일을 받게 됨. 파일이 없으면 에지 로케이션이 원본 파일이 있는 오리진에 접속하여 파일을 가져온 뒤 사용자에게 전달함
- 에지 로케이션이 오리진에서 파일을 가져와서 캐시하게 되면 다른 사용자들도 이 캐시한 파일을 받게 됨. 또한 에지 로케이션이 파일을 캐시하고 있는 동안에는 오리진에 다시 접속하지 않음(뭔가 레지스터와 캐시 메모리의 관계같네..)
- 캐시 파일이 유지되는 시간은 기본적으로 24시간이며 HTTP 헤더의 Cache-Control을 이용하여 시간을 조절할 수 있음. 에지 로케이션에 있는 파일이 즉각 갱신되어야할 경우 무효화 요청을 통해 캐시된 파일을 삭제시킬 수 있음
- 캐시 서버 : 속도가 빠른 곳에 임시로 데이터를 저장하여 속도를 높이는 서버
- 원래 서울리전이 없었을 때는 도쿄리전에 만들어놓고 CloudFront 설정으로 서울 에지 로케이션에다가 캐싱하는 방법으로 만들었었다. 

## 일반적인 CDN 설정과는 다른점

- 동적 콘텐츠 전송을 지원(Dynamic Content Delivery)
  - URL 규칙에 따라 정적 페이지는 캐시, 바로 EC2 인스턴스로 접속하도록 구성 가능.
  - HTTP 메서드 다 지원(GET 말고 다른것들은 캐시되지 않고 바로 오리진으로 전달)
  - HTTP 쿠키 지원
  - 동영상 전송을 위한 라이브 스트리밍 프로토콜 지원
- 선납금이나 최소 약정 사용량이 없고 사용한만큼 지불

## CloudFront 배포

- **Distribution** : CloudFront의 가장 기본적인 단위. 이 배포 하나가 독립적인 도메인을 가지게 됨 이후 DNS서비스인 Route 53이나 별도의 DNS 서버에서 배포 도메인을 CName으로 설정하면 사용자가 구매한 도메인과 연결할 수 있음(S3의 독립적 도메인 => CloudFront의 독립적 도메인 => 내가 구입한 도메인의 CName(Route53))
- **Origin** : CloudFront는 CDN서비스이기 때문에 항상 원본에서 파일을 복사해서 가져와야 함. 이 파일을 가져오는 서버가 오리진임
- CloudFront가 지원하는 오리진 종류
  - S3버킷 : 가징 기본적인 오리진. S3에 버킷을 생성하고 파일을 저장하기만 하면 됨
  - EC2 인스턴스 : EC2 인스턴스에 웹서버를 구축하면 오리진으로 사용할 수 있음
  - ELB : EC2 인스턴스 여러대의 부하를 분산하는 ELB도 오리진으로 사용할 수 있음
  - AWS이외의 웹 서버 : 웹 서버의 형태만 띠고 있다면 운영체제, 서버 애플리케이션의 종류에 상관없이 오리진으로 사용가능

## S3와 CloudFront 연동

설정 개많네

- 가장 기본적인 형태
- CloudFront로 Distribution을 설정하여 배포한다면 S3 리전의 위치는 크게 중요치 않음
- Create Distribution => 전송 방식 선택(Web - 일반적인 웹서버, RTMP - 동영상 실시간 스트리밍 프로토콜)
  - Origin Domain Name : 오리진의 도메인 이름. 현재 사용할 수 있는 S3 버킷과 ELB 목록이 표시 
  - Origin ID : 오리진을 구분하는 ID
  - Restrict Bucket Access : S3 버킷에 클라우드프론트만 접근할 수 있도록 설정하는 옵션
  - Origin Access Identity : 오리진에 접근할 식별자. 새로 생성할 수도 있고 이미 있는 것을 사용할 수도 있음.
  - Comment : 새로 생성할 식별자 이름
  - **Grant Read Permissions on Bucket** : 클라우드프론트가 파일을 읽을 수 있는 권한을 버킷의 Bucket Policy에 설정함. Yes로 설정하면 다른 모든 접속은 제한되고 CloudFront만 접근할 수 있도록 버킷에 Bucket Policy가 설정됨 => 오
  - Path Pattern : CloudFront로 파일을 가져올 규칙. 기본값은 *로 설정되어있기 때문에 모든 파일을 가져오게 됨. 이부분은 여기서는 생성할 수 없고 따로 추가 가능
  - Viewer Protocol Policy : 보여질 프로토콜 정책. HTTP and HTTPS, HTTPs only, Redirect HTTP to HTTPS
  - Allowed HTTP Methods : 허용하는 HTTP 메서드 종류 (GET, HEAD / GET, HEAD, POST 등 전부)
  - **Object Caching** : 캐시의 유지 시간. 유지시간이 지나면 CloudFront에서 파일이 삭제됨
  - Forward Cookies : 오리진의 쿠키를 CloudFront를 거쳐 사용자에게 전달할지 설정. 쿠키를 전달하지 않으면 캐시 성능이 향상됨
  - Forward Query Strings : 오리진으로 쿼리 문자열을 전달
  - Smooth Striming : 실시간 스트리밍 프로토콜을 사용하고 싶을 때
  - Restrict Viewer Access: Signed URL로 CloudFront 사용을 제한하고 싶을 때 설정
  - Price CLass: 요금 수준. 에지 로케이션 사용 범위를 설정하게 되는데, 실제 서비스에서 그다지 필요가 없는 지역을 제외할때 설정. 세부적으로는 못하고 3개 옵션에서 설정(미국유럽, 미국유럽아시아, 전세계)
  - **Alternate Domain Names** : Route 53을 사용하려면 이 부분을 설정해야 함. 여러 도메인이라면 새 줄로 구분하고 최대 10개까지 설정 가능. 각자 구입한 도메인 이름 설정하면 됨
  - **SSL Certificate** : HTTPS 프로토콜을 사용하기 위한 인증서 설정. CloudFront의 인증서 OR 사용자가 구입한 도메인과 인증서 사용할 수 있음
  - Custom SSL Client Support : 커스텀 SSL 설정
  - **Default Root Object** : 최상위 도메인으로 접속했을 때 기본저긍로 보여줄 파일 이름
  - **Logging** : CloudFront 접속 로그 설정.
  - Distribution State: 배포를 생성한 뒤 배포 상태 설정 Enabled면 바로 사용할 수 있는 상태
- 배포가 모든 에지 로케이션에 전파되기까지 15-20분 걸림 => status deployed로 바뀜

## 커스텀 오리진

- 기본 오리진은 일단 S3이긴 한데, EC2, ELB 혹은 외부 웹서버를 오리진으로 사용하는 것을 커스텀 오리진이라고 함
- 커스텀 오리진은 동적 콘텐츠 전송이 필요할 때 사용함. Node, PHP, JSP 서버 사이드 스크립트에서 동적으로 생성되는 웹페이지를 캐시할 수 있음. 특히 커스텀 오리진을 사용하면 동일한 도메인에서 POST, PUT 등 사용 가능
- 음... 근데 웹서버를 CDN해야한다면 이유가 크게 뭘까? : 글로벌 서비스인데 뭔가 유저가 오지게 수정해야 하는 데이터가 있는 경우?
- EC2에 CloudFront를 연결해야 한다면 - 캐싱, 쿠키, SSL, 시네임, HTTP 메소드 뭐 허용할건지 고려
  - **Origin Domain Name** : 오리진 서버의 도메인을 설정하면 됨. EC2 인스턴스의 Public DNS 입력하기 OR 인스턴스에 이미 사용자 구입 도메인을 연결했다면 해당 도메인 써도 됨

## Signed URL

- CloudFront로 배포되는 파일의 사용을 제한하는 기능.
- Singed URL은 특정 날짜가 지나면 파일을 받지 못하게 하고 싶다거나, 특정 날짜 이후에 파일을 받게하고 싶을때, 특정 IP에서만 파일을 받을 수 있도록 할 때 사용
- Canned Policy : 파일 1개의 사용을 제한. 특정 날짜가 지나면 파일을 받지 못하게 하는 기능만 사용할 수 있음. 정책의 내용이 URL에 포함되어 있지 않아 URL의 길이가 짧음
- Custom Policy : 파일 여러개의 사용을 제한. 특정 날짜가 지나면 파일을 받지 못하게 하는 기능. 특정 날짜 이후에 파일을 받을 수 있도록 하는 기능, 특정 IP나 IP 대역에서만 파일을 받을 수 있도록 하는 기능을 사용할 수 있음. URL의 길이가 김
- policy는 json으로 만들어 적용함
- 전용 키쌍과 엑세스 키를 생성해야 함 - 정책 변조 검증을 윟 ㅐ

## Invalidation으로 콘텐츠 갱신

- 캐시가 만료되기 전에(24시간) 파일의 내용을 갱신하고 싶다면 Invalidation(무효화) 사용하면 됨. 에지 로케이션에 저장된 파일의 캐시를 삭제하는 기능. 캐시가 삭제된 뒤 사용자가 해당 파일을 요청하면 에지 로케이션은 오리진에서 새파일을 가져옴
- 뭔가 S3에서 컨텐츠를 바꾸었을 때, 갱신이 바로 적용되지 않는 경우라던가(배포 직후) 사용하는 것
- Create Invalidation : 무효화 요청 생성. 여러개의 파일 경로 입력 가능
- 사실 현실적인 캐싱 : 무효화 요청은 수동으로 진행해야하고 귀찮기 때문에 사실 배포를 할때 에지 로케이션의 파일 캐시가 없을 때 오리진에서 파일을 새로 가져온다는 특성을 이용해 파일의 내용이 바귈대마다 디렉토리 경로나 파일명을 바꾸는 식으로 운영이 가능 => 웹팩의 파일명 해싱 같은... 
- 이렇게 하면 파일의 내용이 바뀔 때 캐시가 없는 새로운 파일이 되므로 무효화 요청 없이, 짧은 시간 안에 파일을 갱신할 수 있음. 빠르면 2-3초 늦어도 1분 안에 파일 갱신 가능
- 캐시 유지 시간을 HTTP 헤더에서 줄이는 방법도 사용은 가능한데, 새 파일을 가져오는 주기가 짧아지므로 전체적인 성능이 느려진다. 오리진에 접근하는 속도가 캐시에 접근하는 속도보다 매우 느리므로 이렇게 되면 CLoudFront캐시를 사용하는 의미가 없어짐