# Elastic Load Balancer

부하분산과 고가용성을 제공하는 ELB

## 설명

- ELB는 고가의 로드밸런싱 장비를 구입하지 않아도 부하 분산 기능을 사용할 수 있고, 고가용성 서비스 구축 가능
- 이게 ㄹㅇ 클라우드로 넘어오면서 매우 편해진 인프라 기술임.
- ELB는 한곳에 집중되는 HTTP, TCP, SSL 트래픽을 여러 EC2 인스턴스로 분산함. 그리고 서버가 정상적으로 가동 중인지 확인(Health Check)하여 일부 EC2 인스턴스가 중단되더라도 트래픽을 정상 EC2 인스턴스로만 보냄. 이처럼 ELB로 부하를 분산하여 고가용성 서비스를 구축할 수 있음
- ELB는 리전별로 생성해야 하고, 여러 가용 영역에서 실행되는 EC2 인스턴스로 부하를 분산시킬 수 있음. 가용 영역 전체가 중단되더라도 서비스를 정상적으로 제공할 수 있음

## 기본 개념

- L4 : OSI 레이어에서 4번째 전송 계층을 뜻함. TCP, UDP 등의 프로토콜이 대표적이며 포트 번호르 구분. OSI 레이어에서 3번째 네트워크 계층의 IP와 묶어서 처리 => L4 로드밸런싱이라고 하면 **IP주소와 포트 번호를 기준**으로 트래픽을 분배함 => 저수준
- L7 : OSI레이어에서 7번째 에플리케이션 계층을 뜻함. HTTP 프로토콜이 대표적. L7로드 밸런싱이라고 하면 HTTP **헤더의 내용을 기준**으로 트래픽을 분배
- 로드 밸런싱 알고리즘 : Ec2인스턴스로 트래픽을 분배할때 사용하는 알고리즘. ELB는 라운드 로빈을 사용함. 우선순위를 두지 않고 순서대로 분배하는 방식
- 헬스 체크 : EC2 인스턴스가 정상적으로 가동 중인지 확인하는 기능. 중단되었다고 판단되면 해당 EC2 인스턴스는 트래픽 분배에서 재외됨
- Connection Draining : 오토스케일링이 사용자의 요청을 처리중인 이시투 인스턴스를 바로 삭제하지 못하도록 방지. 예를 들어 자동 부하분산에서는 사용자 수가 줄어들면 오토 스케일링이 EC2 인스턴스를 삭제함. 마침 사용자가 해당 EC2 인스턴스에서 파일을 다운로드하고 있었는데 EC2가 삭제되면 중간에 끊어짐. 사용자의 요청을 처리할 수 있도록 지정한 시간만큼 기다림.
- Sticky Session : 사용자의 세션을 확인하여 적절한 EC2 인스턴스로 트래픽을 분배하는 기능. L7 로드밸런싱이 이런식으로 동작함. 동일한 사용자가 서비스에 계속 접속할 때 처음 접속했던 EC2 인스턴스에 연결시켜 줌 => 이거 사용하지 않으면 라운드로빈에 따라 매번 다른 Ec2에 연결
- 레이턴시 : EC2와 로드밸런서의 지연시간
- EC2 인스턴스에서 리턴한 HTTP response는 앞에 HTTP, ELB 로드 밸런서에서 리턴한 HTTP 에러는 ELB HTTP
- surge queue length : ELB 로드 밸런서에서 EC2 인스턴스로 전달되지 못하고 큐에 남아있는 요청의 개수
- Spillover count : 서지 큐가 꽉 차서 ELB 로드 밸런서가 거부한 요청의 개수
- 요금 : ELB로드 밸런서 실행 시간과 전송된 데이터 양에 따라 요금이 책정됨

## 사용

- 로드밸런서 생성 - VPC고르기, 이름, 인터넷에 연결되지 않은 내부 로드 밸런서로 생성하는 옵션, VPC에 속한 서브넷을 선택하는 옵션, 로드 밸런서가 처리할 프로토콜과 포트 번호
- 헬스 체크 설정 - HTTP, HTTPS, TCP, SSL중 하나 핑 프로토콜로 설정 가능하고, 포트, 접속 경로, 응답시간, 체크 주기 등등 요청을 넣는 과정을 다 설정해줄 수 있음
- 보안 그룹 설정 : 이때 헬스체크가 이루어질 수 있도록 보안그룹을 설정해줘야 한다. 핑프로토콜이 https인데 https를 막아버리면 안됨 다 막아버리면 못함
- EC2 연결 - 인스턴스 여러개를(사실 2개 이상을 연결해야 말이 되는거겟지 부하분산이...) ELB에 연결할 수 있다. 여러 가용 영역에 생성된 EC2 인스턴스들의 부하를 분산할 수도 있고 Connection Draining을 설정해줄 수도 있다
- 이렇게 인스턴스들에 ELB를 설정해주면 인스턴스에 접속할때 로드밸런서의 DNS로 접속할 수 있게 된다. 약간 인스턴스 DNS를 묶는 역할?도 같이 수행함
- 서버 대충 두개 만들어서 EC2에 둘다 올려보면 왓다갓다하면서 트래픽이 들어오는 것을 확인할 수 있다

## sticky session

- 라운드로빈 알고리즘으로 트래픽을 분배하는 것이 아니라 사용자의 쿠키 세션을 기준으로, 한 세션에 대해 한 인스턴스가 처리하게끔 트래픽을 분배하는 방법 => **근데 왜쓰지**
- 이때 쿠키를 사용한다. => 아마두 로드밸런서가 쿠키를 평가하고 적합한 ec2로 보내주는듯? ELB 로드밸런서가 생성한 쿠키, 서버의 애플리케이션이 생성한 쿠키로 지정해줄 수도 있음
- expiration period 설정에 따라 라운드로빈으로 바꿀 수도 있다
